<!DOCTYPE html>
<html lang="en">

<meta charset="utf-8">

<head>
    <link rel="stylesheet" href="converterpagecss.css">
    <title>Overwatch MIDI converter</title>
</head>

<body>
    <div class="center">
        <a href="https://github.com/ScroogeD2/owmidiconverter">
            <h1>Overwatch MIDI converter</h1>
        </a>

        <div>
            <p>Upload .mid file:
                <input type="file" id="file-input" accept="audio/midi"></input>
            </p>
        </div>

        <p>(Hover over the texts for more information)</p>
        <div class="options">
            <div class="tooltipWrapper">
                <div class="tooltip">Start At:
                    <span class="tooltipText">The time (seconds) in the song
                        when the script starts reading the MIDI data.
                        Set to values other than 0
                        to start reading from different parts of the file.</span>
                </div>
            </div>
            <input class="textInput" type="text" id="startTimeInput" value="0">

            <div class="tooltipWrapper">
                <div class="tooltip">Stop At:
                    <span class="tooltipText">The time (seconds) in the song
                        when the script stops reading MIDI data.</span>
                </div>
            </div>
            <input class="textInput" type="text" id="stopTimeInput" value="100">

            <div class="tooltipWrapper">
                <div class="tooltip">Max Pitches:
                    <span class="tooltipText">Maximum amount of pitches that will be playing
                        at any given time, between 1 and 11. If there are more, they are discarded.
                        Fewer pitches may result in better performance.</span>
                </div>
            </div>
            <input class="textInput" type="text" id="maxPitchesInput" value="6">

            <div class="tooltipWrapper">
                <div class="tooltip">Max Array Elements:
                    <span class="tooltipText">Maximum amount of elements in a single array of the 
                        resulting workshop script that contains the song, between 12 and 999. Fewer elements may cause more 
                        frequent stuttering, while a high amount of elements may result in too large rule sizes. 
                        If unsure, use the default value</span>
                </div>
            </div>
            <input class="textInput" type="text" id="maxElementsInput" value="600">

            <div class="tooltipWrapper">
                <div class="tooltip">Language:
                    <span class="tooltipText">Language of the generated workshop script. 
                        Choose the same language as your game's text language, otherwise the script can't be imported.</span>
                </div>
            </div>
            <select id="languageInput">
                <option selected value="en-US">English</option>
                <option value="es-ES">Español (EU)</option>
                <option value="es-MX">Español (AL)</option>
                <option value="it-IT">Italiano</option>
                <option value="ru-RU">Русский</option>
                <option value="pl-PL">Polski</option>
                <option value="fr-FR">Français</option>
                <option value="de-DE">Deutsch</option>
                <option value="pt-BR">Português</option>
                <option value="ja-JP">日本語</option>
                <option value="ko-KR">한국어</option>
                <option value="zh-TW">繁體中文</option>
                <option value="zh-CN">简体中文</option>
            </select>

            <div class="tooltipWrapper">
                <div class="tooltip">Generate Full Gamemode Settings
                    <span class="tooltipText">If unchecked, only the workshop rules containing the song will be generated. 
                        Make sure to remove all "Song Data" rules before pasting in the new rules.</span>
                </div>
            </div>
            <input class="checkboxInput" type="checkbox" id="includeFullSettingsCheckBox" checked>
        </div>

        <button onclick="loadFile();">Convert MIDI</button>

        <p>Script info:</p>
        <textarea readonly id="scriptOutput-textarea" rows="7"></textarea>

        <p>Copy these settings and paste them to the Custom Game Settings screen:</p>

        <!-- todo: fix textarea lag issues with Chrome -->
        <textarea readonly id="ruleOutput-textarea" rows="5" wrap="off" 
                  autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"></textarea>
        <p></p>
        <button id="copyRuleButton" onclick="copyText('ruleOutput-textarea')">Copy to clipboard</button>
    </div>

    <!-- Import OverPy for language translations -->
    <script src="overpy/doc/actions.js"></script>
    <script src="overpy/doc/values.js"></script>
    <script src="overpy/doc/constants.js"></script>
    <script src="overpy/doc/keywords.js"></script>
    <script src="overpy/doc/specialFuncDoc.js"></script>

    <script src="overpy/utils/compilation.js"></script>
    <script src="overpy/utils/decompilation.js"></script>
    <script src="overpy/utils/logging.js"></script>
    <script src="overpy/utils/optimization.js"></script>
    <script src="overpy/utils/other.js"></script>
    <script src="overpy/utils/translation.js"></script>
    <script src="overpy/utils/varNames.js"></script>

    <script src="overpy/globalVars.js"></script>
    <script src="overpy/decompiler.js"></script>
    <script src="overpy/tokenizer.js"></script>
    <script src="overpy/compiler.js"></script>
    <script src="overpy/doc/stringKw.js"></script>

    <script type="text/javascript" src="https://unpkg.com/@tonejs/midi"></script>
    
    <!-- todo: only import convertMidi and CONVERTER_SETTINGS_INFO instead of the whole file -->
    <script type="text/javascript" src="src/owmidiparser.js"></script>
    <script type="text/javascript" src="src/gamemodeSettings/lobbySettings_AllLanguages.js"></script>
    <script type="text/javascript" src="src/gamemodeSettings/workshopScript_en-US.js"></script>

    <script>

        "use strict";

        const ERRORS = {
            MIDI_CONVERTER_ERROR: "Error: the MIDI file could not be converted.\n",
            TRANSLATION_ERROR: "Error: the generated workshop script could not be translated.\n",
            FILE_FORMAT_ERROR: "Error: the uploaded file could not be read as a MIDI file.\n"
        };
    
        function copyText(elementId) {
            document.getElementById(elementId).select();
            document.execCommand("copy");
        }

        
        function getSettings() {
            // Reads the values in the webpage input fields, 
            // ensures that they're in the correct numerical ranges

            let userSettings = {};

            for (let setting in CONVERTER_SETTINGS_INFO) {

                let userValue = parseFloat(document.getElementById(setting + "Input").value);

                if (isNaN(userValue)) {
                    userValue = CONVERTER_SETTINGS_INFO[setting]["DEFAULT"];
                }

                else if (userValue < CONVERTER_SETTINGS_INFO[setting]["MIN"]) {
                    userValue = CONVERTER_SETTINGS_INFO[setting]["MIN"];
                }

                else if (userValue > CONVERTER_SETTINGS_INFO[setting]["MAX"]) {
                    userValue = CONVERTER_SETTINGS_INFO[setting]["MAX"];
                }

                document.getElementById(setting + "Input").value = userValue;
                userSettings[setting] = userValue;
            }

            return userSettings;
        }


        function updateElementValue(elementId, newValue, keepOldText = false) {
            // Updates text in a webpage element.

            let outputText = "";
            let oldValue = document.getElementById(elementId).value;

            if (keepOldText) {
                outputText = oldValue + newValue;
            } else {
                outputText = newValue;
            }
            document.getElementById(elementId).value = outputText;
        }


        function translateWorkshopScript(script, language) {
            // Translates by decompiling to OverPy script, 
            // then compiling back to workshop script in the selected language

            try {
                // Add disableUnusedVars to avoid clutter
                let overpyScript = "#!disableUnusedVars" + decompileAllRules(script);

                return compile(overpyScript, language).result;
            }
            catch (error) {
                updateElementValue("scriptOutput-textarea", ERRORS["TRANSLATION_ERROR"]);
                console.error(error);
            }
        }


        function parseMidi(mid) {
            const converterSettings = getSettings();
            let convertedMidi = {};
            
            try {
                convertedMidi = convertMidi(mid, converterSettings);
            }
            catch (error) {
                updateElementValue("scriptOutput-textarea", ERRORS["MIDI_CONVERTER_ERROR"]);
                console.error(error);
            }

            if (convertedMidi.rules != "") {
                let scriptLanguage = document.getElementById("languageInput").value;

                // CustomGameSettings consists of lobbySettings and workshopScript
                let customGameSettings = "";
                let workshopScript = "";

                if (document.getElementById("includeFullSettingsCheckBox").checked) {
                    workshopScript += baseWorkshopScript;
                    customGameSettings += lobbySettings[scriptLanguage];
                } else {
                    // Only add variables used in the workshop rules generated by the converter
                    workshopScript += convertedMidiVars;
                }

                workshopScript += convertedMidi.rules;

                if (scriptLanguage != "en-US") {
                    workshopScript = translateWorkshopScript(workshopScript, scriptLanguage);
                }

                customGameSettings += workshopScript;

                updateElementValue("scriptOutput-textarea", convertedMidi.scriptOutput);
                updateElementValue("ruleOutput-textarea", customGameSettings + "\n");
            } else {
                updateElementValue("scriptOutput-textarea", convertedMidi.scriptOutput);
            }
        }


        function loadFile() {
            let file = document.getElementById("file-input").files[0];
            if (!file) {
                return;
            }

            updateElementValue("scriptOutput-textarea", "");
            updateElementValue("ruleOutput-textarea", "");

            const reader = new FileReader();

            reader.onload = function (event) {
                try {
                    let mid = new Midi(event.target.result);
                    parseMidi(mid);
                }
                catch (error) {
                    updateElementValue("scriptOutput-textarea", ERRORS["FILE_FORMAT_ERROR"]);
                    console.error(error);
                }
            }
            reader.readAsArrayBuffer(file);
        }
    </script>
</body>

</html>
